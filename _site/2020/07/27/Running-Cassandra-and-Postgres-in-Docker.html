<p>Today I started thee Udacity <a href="https://www.udacity.com/course/data-engineer-nanodegree--nd027">Data Engineering Nanodegree</a> and wanted to follow along the demo projects in Lesson 1 on my local machine. (However, this is optional as Udacity provides the environment in their workspace).</p>

<p>In this post I describe how to set up the environment using Docker containers for Cassandra and Postgres so that you don’t have to install them locally, which is rather cumbersome, especially for Cassandra as you need to install Java first.</p>

<h2 id="1-creating-cassandra-and-postgres-docker-containers-with-docker-compose">1. Creating Cassandra and Postgres Docker containers with docker-compose</h2>

<p>Create <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> (with exactly this name) with the following content:</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '2'

networks:
  app-tier:
    driver: bridge

services:
  cassandra:
    image: 'cassandra:latest'
    networks:
      - app-tier
    expose: 
      - '6000'
    ports:
      - '6000:9042'
  postgres:
    image: 'postgres:latest'
    restart: always
    environment:
      POSTGRES_PASSWORD: example
    expose:
      - '7000'
    ports:
      - '7000:5432'
</code></pre></div></div>
<p>Here I connect container ports 9042 (for Cassandra) and 5432 (for Postgres), which are default used by these services, with the host ports, here specified as 6000 and 7000.</p>

<p>Creating a yml-document ensures that you don’t have to set up containers each time you want to use them.</p>

<p>To run Docker containers, you just need to type <code class="language-plaintext highlighter-rouge">docker-compose up</code> in your terminal.</p>

<p><strong>Optional</strong>: if you want to check whether Cassandra runs properly, you need first to attach shell to <code class="language-plaintext highlighter-rouge">cassandra:latest</code> container (I will not go into details here, I do it in Visual Studio Code where I have installed Docker extension - more on it <a href="https://code.visualstudio.com/docs/containers/overview">here</a>) and type <code class="language-plaintext highlighter-rouge">cqlsh</code> to run a command line shell for interacting with Cassandra through CQL (the Cassandra Query Language). If no errors thrown, congratulations - you can now use Cassandra docker and run CQL queries. Type <code class="language-plaintext highlighter-rouge">exit</code> to exit the cqlsh terminal.</p>

<p>In a similar way, you can check whether PostgreSQL runs properly - attach shell to <code class="language-plaintext highlighter-rouge">postgres:latest</code> and type <code class="language-plaintext highlighter-rouge">psql --username=postgres</code> to log in as created by default postgres user. Now you can type <code class="language-plaintext highlighter-rouge">\l</code> to see the existing databases, one of which is <code class="language-plaintext highlighter-rouge">postgres</code> which we will be connecting to in Jupyter Notebooks. Type <code class="language-plaintext highlighter-rouge">exit</code> to exit the psql terminal. Type <code class="language-plaintext highlighter-rouge">exit</code> again if you want to exit container shell.</p>

<p>Finally, if you wish to stop the container, just press <code class="language-plaintext highlighter-rouge">Ctrl+C</code> in your terminal. Or check which docker containers are running with <code class="language-plaintext highlighter-rouge">docker ps</code> command in your terminal and then type <code class="language-plaintext highlighter-rouge">docker kill &lt;container-ID as listed when running docker ps command&gt;</code>, replacing the phrase in &lt;&gt; with corresponding ID.</p>

<h2 id="2-setting-up-environment-for-data-engineering-nanodegree">2. Setting up environment for Data Engineering Nanodegree</h2>

<p>In the rest of this post, I describe how to create a virtual environment for Data Engineering Nanodegree and run the jupyter notebooks provided in Lesson 1.</p>

<h2 id="21-create-new-pyenv-environment">2.1. Create new pyenv environment</h2>

<p>In your terminal, go to a folder where you’re going to save all data for Data Engineering Nanodegree and create a new virtual envirnment by running:</p>

<p><code class="language-plaintext highlighter-rouge">pyenv virtualenv &lt;python version&gt; &lt;name of virtual environment&gt;</code>, replacing &lt;&gt; with your own values.</p>

<p>For instance, I created a new virtual environment called “dataengineer” using my current Python version 3.8.2 like so:
<code class="language-plaintext highlighter-rouge">pyenv virtualenv 3.8.2 dataengineer</code></p>

<p>To check which Python version is installed on your computer, try <code class="language-plaintext highlighter-rouge">pyenv version</code>.</p>

<p>Then we activate the new virtual environment with <code class="language-plaintext highlighter-rouge">pyenv activate dataengineer</code> and install the following packages:</p>

<p><code class="language-plaintext highlighter-rouge">pip install jupyter notebook</code></p>

<p><code class="language-plaintext highlighter-rouge">pip install psycopg2-binary</code></p>

<p><code class="language-plaintext highlighter-rouge">pip install cassandra-driver</code></p>

<p>Note that I installed the binary version of psycopg2, as I have an error thrown if I try installing psycopg2 as suggested by Udacity.</p>

<h2 id="22-connect-to-cassandra-and-postgresql-database-in-jupyter-notebook">2.2. Connect to Cassandra and PostgreSQL database in Jupyter Notebook</h2>

<p>After completing steps 1 and 2.1., you can now start using Cassandra within Jupyter Notebook “L1_Demo_2_Creating_a_Table_with_Apache_Cassandra” by specifying the host port from container as following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">cassandra.cluster</span> <span class="kn">import</span> <span class="n">Cluster</span>
<span class="k">try</span><span class="p">:</span> 
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">Cluster</span><span class="p">([</span><span class="s">'127.0.0.1'</span><span class="p">],</span> <span class="n">port</span><span class="o">=</span><span class="mi">6000</span><span class="p">)</span> <span class="c1">#If you have a locally installed Apache Cassandra instance
</span>    <span class="n">session</span> <span class="o">=</span> <span class="n">cluster</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
<span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div></div>

<p>In the same way, you can start PostgreSQL within Jupyter Notebook “L1_Demo_0_creating-a-table-with-postgres” by specifying the host port and password from container as following:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="s">"host=127.0.0.1 port=7000 dbname=postgres user=postgres password=example"</span><span class="p">)</span>
</code></pre></div></div>

<p>Use this connection and cluster for all other jupyter notebooks in Lesson 1.</p>

